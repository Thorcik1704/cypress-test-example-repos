version: 2

defaults: &defaults
  parallelism: 1
  working_directory: ~/app
  docker:
    - image: cypress/internal:chrome61
      environment:
        ## this enables colors + fixes failing unit tests
        TERM: xterm

jobs:
  kitchensink:
    <<: *defaults
    steps:
      - run: git clone https://github.com/cypress-io/cypress-example-kitchensink.git
      - restore_cache:
          key: deps
      - run: cd cypress-example-kitchensink && npm install
      - save_cache:
          key: deps-{{ checksum "cypress-example-kitchensink/package.json" }}
          paths:
            - cypress-example-kitchensink/node_modules
      - run: echo install $CYPRESS_NPM_PACKAGE_NAME
      - run: cd cypress-example-kitchensink && npm install $CYPRESS_NPM_PACKAGE_NAME
      - run:
          name: start server
          command: cd cypress-example-kitchensink && npm start
          background: true
      - run: cd cypress-example-kitchensink && $(npm bin)/cypress run

  recipes:
    <<: *defaults
    steps:
      - run: git clone https://github.com/cypress-io/cypress-example-recipes.git
      - run: |
          cd cypress-example-recipes
          npm install
          echo install $CYPRESS_NPM_PACKAGE_NAME
          npm install $CYPRESS_NPM_PACKAGE_NAME
          npm start &
          $(npm bin)/cypress run

  todomvc:
    <<: *defaults
    steps:
      - run: git clone https://github.com/cypress-io/cypress-example-todomvc.git
      - run: |
          cd cypress-example-todomvc
          npm install
          echo install $CYPRESS_NPM_PACKAGE_NAME
          npm install $CYPRESS_NPM_PACKAGE_NAME
          npm start &
          $(npm bin)/cypress run --headed

  phonecat:
    <<: *defaults
    steps:
      - run: git clone https://github.com/cypress-io/cypress-example-phonecat.git
      - run: |
          cd cypress-example-phonecat
          npm install
          npm install wait-on
          echo install $CYPRESS_NPM_PACKAGE_NAME
          npm install $CYPRESS_NPM_PACKAGE_NAME
          npm start &
          $(npm bin)/wait-on http://localhost:8000 && $(npm bin)/cypress run --browser chrome

  piechopper:
    <<: *defaults
    steps:
      - run: git clone https://github.com/cypress-io/cypress-example-piechopper.git
      - run: |
          cd cypress-example-piechopper
          npm install
          npm install wait-on
          echo install $CYPRESS_NPM_PACKAGE_NAME
          npm install $CYPRESS_NPM_PACKAGE_NAME
          npm run build
          npm start &
          $(npm bin)/wait-on http://localhost:8080 && $(npm bin)/cypress run

workflows:
  version: 2
  test-example-repos:
    jobs:
      - kitchensink
      - recipes
      - todomvc
      - phonecat
      - piechopper
