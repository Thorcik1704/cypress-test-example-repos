version: 2.1

executors:
  mac:
    macos:
      xcode: "10.1.0"

commands:
  set-failed-status:
    description: |
      Sets commit status to failures if necessary
      for the original Test Runner commit.
    steps:
      - run:
          when: on_fail
          name: Set status check
          command: $(npm bin)/set-status --state failure --description "$CIRCLE_STAGE on CircleCI"

  set-passed-status:
    description: |
      Sets commit status to success if necessary
      for the original Test Runner commit.
    steps:
      - run:
          when: on_success
          name: Set status check
          command: $(npm bin)/set-status --state success --description "on CircleCI"

  early-stop:
    description: |
      Early halt if this commit is for testing binaries for different platform
      Place this command AFTER checkout command because we need to look
      at the commit subject text
    parameters:
      substring:
        type: string
        description: String to search for in the commit subject to skip build
    steps:
      - run:
          name: Checking OS platform for "<< parameters.substring >>"
          command: |
            subject=$(git show -s --pretty=%s)
            echo "Commit subject: $subject"

            if [[ $subject == *"<< parameters.substring >>"* ]]; then
              echo Skipping testing binary ‚è≠
              echo Found string "<< parameters.substring >>"
              circleci step halt
            fi

defaults: &defaults
  parallelism: 1
  working_directory: ~/app
  docker:
    - image: cypress/browsers:chrome69
      environment:
        COMMIT_MESSAGE_INSTALL: commit-message-install@2

jobs:
  lint:
    <<: *defaults
    steps:
      - checkout
      - early-stop:
          substring: Testing new win32
      - restore_cache:
          key: root-group
      - run: npm install
      - save_cache:
          key: root-group-{{ checksum "package.json" }}
          paths:
            - node_modules
      - run: npm run lint

  "example-group-staging":
    <<: *defaults
    steps:
      - checkout
      - early-stop:
          substring: Testing new win32
      - run: git clone https://github.com/cypress-io/cypress-example-group.git
      - restore_cache:
          key: deps-example-group-staging
      - run:
          working_directory: cypress-example-group
          command: git log -1
      - run:
          name: Remove .git subfolder
          working_directory: cypress-example-group
          command: rm -rf .git
      - run:
          working_directory: cypress-example-group
          command: npm install
      - run:
          working_directory: cypress-example-group
          command: npm install $COMMIT_MESSAGE_INSTALL
      - save_cache:
          key: deps-example-group-staging-{{ checksum "cypress-example-group/package.json" }}
          paths:
            - cypress-example-group/node_modules
      - run:
          working_directory: cypress-example-group
          command: $(npm bin)/commit-message-install
      - run:
          name: Run a test that is part of a group
          working_directory: cypress-example-group
          command: |
            CYPRESS_ENV=staging \
            CYPRESS_PROJECT_ID=$EXAMPLE_GROUP_STAGING_PROJECT_ID \
            CYPRESS_RECORD_KEY=$EXAMPLE_GROUP_STAGING_RECORD_KEY \
            $(npm bin)/run-if npm run cy:run -- --group --record --group-id $CIRCLE_BUILD_NUM
      - run:
          name: Run test using Chrome but put in the same group
          working_directory: cypress-example-group
          command: |
            CYPRESS_ENV=staging \
            CYPRESS_PROJECT_ID=$EXAMPLE_GROUP_STAGING_PROJECT_ID \
            CYPRESS_RECORD_KEY=$EXAMPLE_GROUP_STAGING_RECORD_KEY \
            $(npm bin)/run-if npm run cy:run -- --group --record --browser chrome --group-id $CIRCLE_BUILD_NUM
      - set-failed-status

  # pass explicit group id to run same tests multiple times
  # using CircleCI parallelism option
  # https://circleci.com/docs/2.0/configuration-reference/#job_name
  # all jobs will have same CIRCLE_BUILD_NUM for example
  "example-group-id-staging":
    <<: *defaults
    parallelism: 4
    steps:
      - checkout
      - early-stop:
          substring: Testing new win32
      - run: git clone https://github.com/cypress-io/cypress-example-group.git
      - restore_cache:
          key: deps-example-group-id-staging
      - run:
          working_directory: cypress-example-group
          command: git log -1
      - run:
          name: Remove .git subfolder
          working_directory: cypress-example-group
          command: rm -rf .git
      - run:
          working_directory: cypress-example-group
          command: npm install
      - run:
          working_directory: cypress-example-group
          command: npm install $COMMIT_MESSAGE_INSTALL
      - save_cache:
          key: deps-example-group-id-staging-{{ checksum "cypress-example-group/package.json" }}
          paths:
            - cypress-example-group/node_modules
      - run:
          working_directory: cypress-example-group
          command: $(npm bin)/commit-message-install
      - run:
          name: Run tests and group them by build number
          working_directory: cypress-example-group
          command: |
            CYPRESS_ENV=staging \
            CYPRESS_PROJECT_ID=$EXAMPLE_GROUP_STAGING_PROJECT_ID \
            CYPRESS_RECORD_KEY=$EXAMPLE_GROUP_STAGING_RECORD_KEY \
            $(npm bin)/run-if npm run cy:run -- --group --record --group-id $CIRCLE_BUILD_NUM
      - set-failed-status
      # store NPM logs in case there was a problem
      - store_artifacts:
          path: ~/.npm/_logs

  kitchensink-mac:
    working_directory: ~/app
    executor: mac
    steps:
      - checkout
      - early-stop:
          substring: Testing new win32
      - early-stop:
          substring: Testing new linux
      - restore_cache:
          key: root-deps-{{ arch }}-{{ .Branch }}-
      - run: npm install
      - save_cache:
          key: root-deps-{{ arch }}-{{ .Branch }}-{{ checksum "package.json" }}
          paths:
            - node_modules
      - run: npm run test-if -- --repo cypress-example-kitchensink
      - set-failed-status
      - store_artifacts:
          path: cypress-example-kitchensink/cypress/screenshots
      - store_artifacts:
          path: cypress-example-kitchensink/cypress/videos
        # store NPM logs in case there was a problem
      - store_artifacts:
          path: ~/.npm/_logs

  kitchensink:
    <<: *defaults
    steps:
      - checkout
      - early-stop:
          substring: Testing new win32
      - restore_cache:
          key: root-deps-{{ arch }}-{{ .Branch }}-
      - run: npm install
      - save_cache:
          key: root-deps-{{ arch }}-{{ .Branch }}-{{ checksum "package.json" }}
          paths:
            - node_modules
      - run: npm run test-if -- --repo cypress-example-kitchensink
      - set-failed-status
      - store_artifacts:
          path: cypress-example-kitchensink/cypress/screenshots
      - store_artifacts:
          path: cypress-example-kitchensink/cypress/videos
        # store NPM logs in case there was a problem
      - store_artifacts:
          path: ~/.npm/_logs

  "kitchensink-chrome":
    <<: *defaults
    steps:
      - checkout
      - early-stop:
          substring: Testing new win32
      - restore_cache:
          key: root-deps-{{ arch }}-{{ .Branch }}-
      - run: npm install
      - save_cache:
          key: root-deps-{{ arch }}-{{ .Branch }}-{{ checksum "package.json" }}
          paths:
            - node_modules
      - run: npm run test-if -- --repo cypress-example-kitchensink --command test:ci:chrome
      - set-failed-status
      - store_artifacts:
          path: cypress-example-kitchensink/cypress/screenshots
      - store_artifacts:
          path: cypress-example-kitchensink/cypress/videos
        # store NPM logs in case there was a problem
      - store_artifacts:
          path: ~/.npm/_logs

  recipes:
    <<: *defaults
    steps:
      - checkout
      - early-stop:
          substring: Testing new win32
      - restore_cache:
          key: root-deps
      - run: npm install
      - save_cache:
          key: root-deps-{{ checksum "package.json" }}
          paths:
            - node_modules
      - run: npm run test-if -- --repo cypress-example-recipes --command test:ci
      - set-failed-status
      - store_artifacts:
          path: cypress-example-kitchensink/cypress/screenshots
      - store_artifacts:
          path: cypress-example-kitchensink/cypress/videos
      - store_artifacts:
          # store NPM logs in case there was a problem
          path: ~/.npm/_logs

  recipes-chrome:
    <<: *defaults
    steps:
      - checkout
      - early-stop:
          substring: Testing new win32
      - restore_cache:
          key: root-deps
      - run: npm install
      - save_cache:
          key: root-deps-{{ checksum "package.json" }}
          paths:
            - node_modules
      - run: npm run test-if -- --repo cypress-example-recipes --command test:ci:chrome
      - set-failed-status
      - store_artifacts:
          path: cypress-example-kitchensink/cypress/screenshots
      - store_artifacts:
          path: cypress-example-kitchensink/cypress/videos
      - store_artifacts:
          # store NPM logs in case there was a problem
          path: ~/.npm/_logs

  todomvc-mac:
    working_directory: ~/app
    executor: mac
    steps:
      - checkout
      - early-stop:
          substring: Testing new win32
      - early-stop:
          substring: Testing new linux
      - restore_cache:
          key: root-deps-{{ arch }}-{{ .Branch }}-
      - run: npm install
      - save_cache:
          key: root-deps-{{ arch }}-{{ .Branch }}-{{ checksum "package.json" }}
          paths:
            - node_modules
      - run: npm run test-if -- --repo cypress-example-todomvc --command test:ci:record
      - set-failed-status
      # store NPM logs in case there was a problem
      - store_artifacts:
          path: ~/.npm/_logs

  todomvc:
    <<: *defaults
    steps:
      - checkout
      - early-stop:
          substring: Testing new win32
      - restore_cache:
          key: root-deps-{{ arch }}-{{ .Branch }}-
      - run: npm install
      - save_cache:
          key: root-deps-{{ arch }}-{{ .Branch }}-{{ checksum "package.json" }}
          paths:
            - node_modules
      - run: npm run test-if -- --repo cypress-example-todomvc --command test:ci:record
      - set-failed-status
      # store NPM logs in case there was a problem
      - store_artifacts:
          path: ~/.npm/_logs

  todomvc-headed:
    <<: *defaults
    steps:
      - checkout
      - early-stop:
          substring: Testing new win32
      - restore_cache:
          key: root-deps-{{ arch }}-{{ .Branch }}-
      - run: npm install
      - save_cache:
          key: root-deps-{{ arch }}-{{ .Branch }}-{{ checksum "package.json" }}
          paths:
            - node_modules
      - run: npm run test-if -- --repo cypress-example-todomvc --command test:ci:headed
        # store NPM logs in case there was a problem
      - set-failed-status
      - store_artifacts:
          path: ~/.npm/_logs

  todomvc-chrome:
    <<: *defaults
    steps:
      - checkout
      - early-stop:
          substring: Testing new win32
      - restore_cache:
          key: root-deps-{{ arch }}-{{ .Branch }}-
      - run: npm install
      - save_cache:
          key: root-deps-{{ arch }}-{{ .Branch }}-{{ checksum "package.json" }}
          paths:
            - node_modules
      - run: npm run test-if -- --repo cypress-example-todomvc --command test:ci:chrome
        # store NPM logs in case there was a problem
      - set-failed-status
      - store_artifacts:
          path: ~/.npm/_logs

  phonecat:
    <<: *defaults
    steps:
      - checkout
      - early-stop:
          substring: Testing new win32
      - restore_cache:
          key: root-deps
      - run: npm install
      - save_cache:
          key: root-deps-{{ checksum "package.json" }}
          paths:
            - node_modules
      - run: npm run test-if -- --repo cypress-example-phonecat --command test:ci
        # store NPM logs in case there was a problem
      - set-failed-status
      - store_artifacts:
          path: ~/.npm/_logs

  piechopper:
    <<: *defaults
    steps:
      - checkout
      - early-stop:
          substring: Testing new win32
      - restore_cache:
          key: root-deps
      - run: npm install
      - save_cache:
          key: root-deps-{{ checksum "package.json" }}
          paths:
            - node_modules
      - run: npm run test-if -- --repo cypress-example-piechopper --command test:ci
        # store NPM logs in case there was a problem
      - set-failed-status
      - store_artifacts:
          path: ~/.npm/_logs

  cypress-svelte-unit-test:
    <<: *defaults
    steps:
      - checkout
      - early-stop:
          substring: Testing new win32
      - restore_cache:
          key: root-deps
      - run: npm install
      - save_cache:
          key: root-deps-{{ checksum "package.json" }}
          paths:
            - node_modules
      - run: npm run test-if -- --repo bahmutov/cypress-svelte-unit-test --command test
        # store NPM logs in case there was a problem
      - set-failed-status
      - store_artifacts:
          path: ~/.npm/_logs

  cypress-vue-unit-test:
    <<: *defaults
    steps:
      - checkout
      - early-stop:
          substring: Testing new win32
      - restore_cache:
          key: root-deps
      - run: npm install
      - save_cache:
          key: root-deps-{{ checksum "package.json" }}
          paths:
            - node_modules
      - run: npm run test-if -- --repo bahmutov/cypress-vue-unit-test --command test
        # store NPM logs in case there was a problem
      - set-failed-status
      - store_artifacts:
          path: ~/.npm/_logs

  cypress-react-unit-test:
    <<: *defaults
    steps:
      - checkout
      - early-stop:
          substring: Testing new win32
      - restore_cache:
          key: root-deps
      - run: npm install
      - save_cache:
          key: root-deps-{{ checksum "package.json" }}
          paths:
            - node_modules
      - run: npm run test-if -- --repo bahmutov/cypress-react-unit-test --command test
        # store NPM logs in case there was a problem
      - set-failed-status
      - store_artifacts:
          path: ~/.npm/_logs

  cypress-hyperapp-unit-test:
    <<: *defaults
    steps:
      - checkout
      - early-stop:
          substring: Testing new win32
      - restore_cache:
          key: root-deps
      - run: npm install
      - save_cache:
          key: root-deps-{{ checksum "package.json" }}
          paths:
            - node_modules
      - run: npm run test-if -- --repo bahmutov/cypress-hyperapp-unit-test --command test:ci
        # store NPM logs in case there was a problem
      - set-failed-status
      - store_artifacts:
          path: ~/.npm/_logs

  cypress-cycle-unit-test:
    <<: *defaults
    steps:
      - checkout
      - early-stop:
          substring: Testing new win32
      - restore_cache:
          key: root-deps
      - run: npm install
      - save_cache:
          key: root-deps-{{ checksum "package.json" }}
          paths:
            - node_modules
      - run: npm run test-if -- --repo bahmutov/cypress-cycle-unit-test --command test
        # store NPM logs in case there was a problem
      - set-failed-status
      - store_artifacts:
          path: ~/.npm/_logs

  workshop:
    <<: *defaults
    steps:
      - checkout
      - early-stop:
          substring: Testing new win32
      - restore_cache:
          key: root-deps
      - run: npm install
      - save_cache:
          key: root-deps-{{ checksum "package.json" }}
          paths:
            - node_modules
      - run: npm run test-if -- --repo testing-workshop-cypress --command ci
      - set-failed-status
      - store_artifacts:
          path: testing-workshop-cypress/cypress/screenshots
      - store_artifacts:
          path: testing-workshop-cypress/cypress/videos
      - store_artifacts:
          # store NPM logs in case there was a problem
          path: ~/.npm/_logs

  after-tests:
    <<: *defaults
    steps:
      - checkout
      - early-stop:
          substring: Testing new win32
      # we only need a single NPM package for status check
      - run: npm install @cypress/commit-message-install
      - set-passed-status

  after-tests-mac:
    working_directory: ~/app
    executor: mac
    steps:
      - checkout
      - early-stop:
          substring: Testing new win32
      - early-stop:
          substring: Testing new linux
      # we only need a single NPM package for status check
      - run: npm install @cypress/commit-message-install
      - set-passed-status

workflows:
  version: 2
  mac-tests:
    jobs:
      - kitchensink-mac
      - todomvc-mac
      - after-tests-mac:
          requires:
            - kitchensink-mac
            - todomvc-mac

  linux-tests:
    jobs:
      - lint
      - kitchensink
      - kitchensink-chrome
      # - example-group-staging
      # - example-group-id-staging
      - recipes
      - recipes-chrome
      - todomvc
      - todomvc-headed
      - todomvc-chrome
      - phonecat
      - piechopper
      - cypress-svelte-unit-test
      - cypress-vue-unit-test
      - cypress-react-unit-test
      - cypress-hyperapp-unit-test
      - cypress-cycle-unit-test
      - workshop
      # after all jobs finish successfully
      # we can set success commit status
      - after-tests:
          requires:
            - kitchensink
            - kitchensink-chrome
            - recipes
            - recipes-chrome
            - todomvc
            - todomvc-headed
            - todomvc-chrome
            - phonecat
            - piechopper
            - cypress-svelte-unit-test
            - cypress-vue-unit-test
            - cypress-react-unit-test
            - cypress-hyperapp-unit-test
            - cypress-cycle-unit-test
            - workshop
